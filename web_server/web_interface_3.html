<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programmable Load Control</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #1a1a1a;
            color: #fff;
        }

        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 600px;
        }

        h1 {
            text-align: center;
        }

        .section {
            margin-bottom: 20px;
        }

        .section span {
            color: #4CAF50;
            font-weight: bold;
        }

        input[type="number"], select {
            background-color: #333;
            color: white;
            border: 1px solid #4CAF50;
            padding: 8px;
            border-radius: 4px;
            margin-right: 10px;
            width: 100%;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background-color: #45a049;
        }

        button:active {
            transform: scale(0.95);
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Programmable Load Control</h1>

        <!-- Measurements -->
        <div class="section">
            <h2>Measurements</h2>
            <p><strong>Voltage:</strong> <span id="voltage">0.0000</span> V</p>
            <p><strong>Current:</strong> <span id="current">0.0000</span> A</p>
            <p><strong>Power:</strong> <span id="power">0.0000</span> W</p>
            <p><strong>Internal Temperature:</strong> <span id="temperature_internal">0.0000</span> °C</p>
            <p><strong>External Temperature 1:</strong> <span id="temperature_external_1">0.0000</span> °C</p>
            <p><strong>External Temperature 2:</strong> <span id="temperature_external_2">0.0000</span> °C</p>
            <p><strong>External Temperature 3:</strong> <span id="temperature_external_3">0.0000</span> °C</p>
        </div>

        <!-- Mode Selection -->
        <div class="section">
            <h2>Control Mode</h2>
            <select id="control_mode">
                <option value="MODE_CC">Constant Current (CC)</option>
                <option value="MODE_CV">Constant Voltage (CV)</option>
                <option value="MODE_CP">Constant Power (CP)</option>
            </select>
            <button onclick="updateControlMode()">Set Mode</button>
        </div>

        <!-- Setpoint -->
        <div class="section">
            <h2>Setpoint</h2>
            <p>The setpoint defines the target value for the selected mode:</p>
            <ul>
                <li><span>CC Mode:</span> Target current (Amps).</li>
                <li><span>CV Mode:</span> Target voltage (Volts).</li>
                <li><span>CP Mode:</span> Target power (Watts).</li>
            </ul>
            <input type="number" id="setpoint" step="0.01" placeholder="Enter setpoint">
            <button onclick="updateSetpoint()">Update Setpoint</button>
        </div>

        <!-- Start/Stop -->
        <div class="section">
            <h2>Start/Stop</h2>
            <button id="startstop_button" onclick="toggleStartStop(this)">Start</button>
        </div>

        <!-- Safety Limits -->
        <div class="section">
            <h2>Safety Limits</h2>
            <p><span>Hard Limits:</span> If exceeded, the load will stop completely.</p>
            <p><span>Soft Limits:</span> If exceeded, the system will adjust the PWM signal to stay within limits.</p>
            <h3>Hard Limits</h3>
            <input type="number" id="max_voltage_user" placeholder="Max Voltage (V)">
            <input type="number" id="min_voltage_user" placeholder="Min Voltage (V)">
            <input type="number" id="max_current_user" placeholder="Max Current (A)">
            <input type="number" id="max_power_user" placeholder="Max Power (W)">
            <input type="number" id="max_temperature_user" placeholder="Max Temperature (°C)">
            <h3>Soft Limits</h3>
            <input type="number" id="soft_max_voltage" placeholder="Soft Max Voltage (V)">
            <input type="number" id="soft_max_current" placeholder="Soft Max Current (A)">
            <input type="number" id="soft_max_temperature" placeholder="Soft Max Temperature (°C)">
            <button onclick="updateSafetyLimits()">Set Safety Limits</button>
        </div>
    </div>

    <script>
        async function fetchMeasurements() {
            const response = await fetch('/measurement');
            const data = await response.json();
            document.getElementById('voltage').textContent = data.voltage.toFixed(4);
            document.getElementById('current').textContent = data.current.toFixed(4);
            document.getElementById('power').textContent = data.power.toFixed(4);
            document.getElementById('temperature_internal').textContent = data.temperature_internal.toFixed(4);
            document.getElementById('temperature_external_1').textContent = data.temperature_external_1.toFixed(4);
            document.getElementById('temperature_external_2').textContent = data.temperature_external_2.toFixed(4);
            document.getElementById('temperature_external_3').textContent = data.temperature_external_3.toFixed(4);
        }

        async function updateSetpoint() {
            const setpoint = document.getElementById('setpoint').value;
            await fetch('/setpoint', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: setpoint,
            });
        }

        async function updateControlMode() {
            const mode = document.getElementById('control_mode').value;
            await fetch('/mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: mode,
            });
        }

        async function toggleStartStop(button) {
            const action = button.textContent === "Start" ? "start" : "stop";
            await fetch('/startstop', {
                method: 'POST',
                body: action,
            });
            button.textContent = action === "start" ? "Stop" : "Start";
        }

        async function updateSafetyLimits() {
            const safetyData = {
                max_voltage_user: parseFloat(document.getElementById('max_voltage_user').value),
                min_voltage_user: parseFloat(document.getElementById('min_voltage_user').value),
                max_current_user: parseFloat(document.getElementById('max_current_user').value),
                max_power_user: parseFloat(document.getElementById('max_power_user').value),
                max_temperature_user: parseFloat(document.getElementById('max_temperature_user').value),
                soft_max_voltage: parseFloat(document.getElementById('soft_max_voltage').value),
                soft_max_current: parseFloat(document.getElementById('soft_max_current').value),
                soft_max_temperature: parseFloat(document.getElementById('soft_max_temperature').value),
            };
            await fetch('/safety', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(safetyData),
            });
        }

        setInterval(fetchMeasurements, 1000);
    </script>
</body>

</html>